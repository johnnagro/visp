#!/usr/bin/env bash

set -ex

# Narrow script for working with interfaces and routes.
# Meant for password-less sudo.
#
# Usage:
#   sudo -n -- bin/visp-ip tun tun0 fc12::3456
#   sudo -n -- bin/visp-ip addr tun0 172.23.23.2
#   sudo -n -- bin/visp-ip route tun0 172.23.23.0/24
#   sudo -n -- bin/visp-ip gw default 172.23.23.1
#   sudo -n -- bin/visp-ip nat tun0 eth0
#
# If peered over UDP, add host routes before adding the default route:
#   sudo -n -- bin/visp-ip gw 37.139.20.30 192.168.3.1

cmd=$1
ifname=$2
addr=$3

if [[ "$cmd" = "tun" ]]; then
  ip tuntap add mode tun dev "$ifname"
  ip addr add "$addr"/8 dev "$ifname"
  ip link set mtu 1304 dev "$ifname"
  ip link set "$ifname" up
fi

if [[ "$cmd" = "addr" ]]; then
  ip addr add dev "$ifname" "$addr"
fi

if [[ "$cmd" = "route" ]]; then
  ip route add dev "$ifname" "$addr"
fi

if [[ "$cmd" = "gw" ]]; then
  gw=$addr
  addr=$ifname
  ip route add "$addr" via "$gw"
fi

if [[ "$cmd" = "nat" ]]; then
  echo TODO: enable forwarding and NAT
  exit 1
fi
