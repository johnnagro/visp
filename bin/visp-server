#!/usr/bin/env ruby
# encoding: utf-8

require 'visp'

address = ENV['ADDRESS'] || '127.0.0.1'
port = ENV['PORT'] || 3000

HTTPkit.start do
  cjdns = VISP::Cjdns.new(address: '127.0.0.1', port: 11234, password: 'foo')
  journal = File.open('./leases.json', 'a+')
  visp = VISP.new(cjdns, journal)
  visp.replay_journal

  HTTPkit::Server.start(address: address, port: port,
                        handlers: [VISP::Server.new(visp)])

  EM.add_periodic_timer(5) do
    Fiber.new { visp.maintain_leases }.resume
  end
end
